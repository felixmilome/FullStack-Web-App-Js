{"ast":null,"code":"var fs = require('fs');\n\nvar path = require('path');\n\nvar util = require('util');\n\nvar events = require('events');\n\nvar hasNativeRecursive = require('./has-native-recursive');\n\nvar is = require('./is');\n\nvar EVENT_UPDATE = 'update';\nvar EVENT_REMOVE = 'remove';\n\nfunction hasDup(arr) {\n  return arr.some(function (v, i, self) {\n    return self.indexOf(v) !== i;\n  });\n}\n\nfunction unique(arr) {\n  return arr.filter(function (v, i, self) {\n    return self.indexOf(v) === i;\n  });\n}\n\nfunction assertEncoding(encoding) {\n  if (encoding && encoding !== 'buffer' && !Buffer.isEncoding(encoding)) {\n    throw new Error('Unknown encoding: ' + encoding);\n  }\n}\n\nfunction guard(fn) {\n  return function (arg, action) {\n    if (is.func(fn)) {\n      if (fn(arg)) action();\n    } else if (is.regExp(fn)) {\n      if (fn.test(arg)) action();\n    } else {\n      action();\n    }\n  };\n}\n\nfunction composeMessage(names) {\n  return names.map(function (n) {\n    return is.exists(n) ? [EVENT_UPDATE, n] : [EVENT_REMOVE, n];\n  });\n}\n\nfunction getMessages(cache) {\n  var filtered = unique(cache); // Saving file from an editor? If so, assuming the\n  // non-existed files in the cache are temporary files\n  // generated by an editor and thus be filtered.\n\n  var reg = /~$|^\\.#|^##$/g;\n  var hasSpecialChar = cache.some(function (c) {\n    return reg.test(c);\n  });\n\n  if (hasSpecialChar) {\n    var dup = hasDup(cache.map(function (c) {\n      return c.replace(reg, '');\n    }));\n\n    if (dup) {\n      filtered = filtered.filter(function (m) {\n        return is.exists(m);\n      });\n    }\n  } // Prevent redundant event for its parent when creating file/directory.\n  // The operation is kinda expensive so only be triggered under Windows.\n  // https://github.com/yuanchuan/node-watch/issues/79\n\n\n  if (is.windows()) {\n    var parents = filtered.map(function (n) {\n      return path.parse(n).dir;\n    });\n    filtered = filtered.filter(function (n) {\n      // Skip on removal\n      if (!is.exists(n)) {\n        return true;\n      } // Ignore the parent directory\n\n\n      return !parents.some(function (m) {\n        return is.samePath(n, m);\n      });\n    });\n  }\n\n  return composeMessage(filtered);\n}\n\nfunction debounce(info, fn) {\n  var timer,\n      cache = [];\n  var encoding = info.options.encoding;\n  var delay = info.options.delay;\n\n  if (!is.number(delay)) {\n    delay = 200;\n  }\n\n  function handle() {\n    getMessages(cache).forEach(function (msg) {\n      msg[1] = Buffer.from(msg[1]);\n\n      if (encoding !== 'buffer') {\n        msg[1] = msg[1].toString(encoding);\n      }\n\n      fn.apply(null, msg);\n    });\n    timer = null;\n    cache = [];\n  }\n\n  return function (rawEvt, name) {\n    cache.push(name);\n\n    if (!timer) {\n      timer = setTimeout(handle, delay);\n    }\n  };\n}\n\nfunction createDupsFilter() {\n  var memo = {};\n  return function (fn) {\n    return function (evt, name) {\n      memo[evt + name] = [evt, name];\n      setTimeout(function () {\n        Object.keys(memo).forEach(function (n) {\n          fn.apply(null, memo[n]);\n        });\n        memo = {};\n      });\n    };\n  };\n}\n\nfunction getSubDirectories(dir, fn, done = function () {}) {\n  if (is.directory(dir)) {\n    fs.readdir(dir, function (err, all) {\n      if (err) {\n        // don't throw permission errors.\n        if (/^(EPERM|EACCES)$/.test(err.code)) {\n          console.warn('Warning: Cannot access %s.', dir);\n        } else {\n          throw err;\n        }\n      } else {\n        all.forEach(function (f) {\n          var sdir = path.join(dir, f);\n          if (is.directory(sdir)) fn(sdir);\n        });\n        done();\n      }\n    });\n  } else {\n    done();\n  }\n}\n\nfunction semaphore(final) {\n  var counter = 0;\n  return function start() {\n    counter++;\n    return function stop() {\n      counter--;\n      if (counter === 0) final();\n    };\n  };\n}\n\nfunction nullCounter() {\n  return function nullStop() {};\n}\n\nvar deprecationWarning = util.deprecate(function () {}, '(node-watch) First param in callback function\\\n  is replaced with event name since 0.5.0, use\\\n  `(evt, filename) => {}` if you want to get the filename');\n\nfunction Watcher() {\n  events.EventEmitter.call(this);\n  this.watchers = {};\n  this._isReady = false;\n  this._isClosed = false;\n}\n\nutil.inherits(Watcher, events.EventEmitter);\n\nWatcher.prototype.expose = function () {\n  var self = this;\n  var methods = ['on', 'emit', 'close', 'isClosed', 'listeners', 'once', 'setMaxListeners', 'getMaxListeners'];\n  return methods.reduce(function (expose, name) {\n    expose[name] = function () {\n      return self[name].apply(self, arguments);\n    };\n\n    return expose;\n  }, {});\n};\n\nWatcher.prototype.isClosed = function () {\n  return this._isClosed;\n};\n\nWatcher.prototype.close = function (fullPath) {\n  var self = this;\n\n  if (fullPath) {\n    var watcher = this.watchers[fullPath];\n\n    if (watcher && watcher.close) {\n      watcher.close();\n      delete self.watchers[fullPath];\n    }\n\n    getSubDirectories(fullPath, function (fpath) {\n      self.close(fpath);\n    });\n  } else {\n    Object.keys(self.watchers).forEach(function (fpath) {\n      var watcher = self.watchers[fpath];\n\n      if (watcher && watcher.close) {\n        watcher.close();\n      }\n    });\n    this.watchers = {};\n  } // Do not close the Watcher unless all child watchers are closed.\n  // https://github.com/yuanchuan/node-watch/issues/75\n\n\n  if (is.emptyObject(self.watchers)) {\n    this._isClosed = true;\n    process.nextTick(emitClose, this);\n  }\n};\n\nfunction emitReady(self) {\n  if (!self._isReady) {\n    self._isReady = true; // do not call emit for 'ready' until after watch() has returned,\n    // so that consumer can call on().\n\n    process.nextTick(function () {\n      self.emit('ready');\n    });\n  }\n}\n\nfunction emitClose(self) {\n  self.emit('close');\n}\n\nWatcher.prototype.add = function (watcher, info) {\n  var self = this;\n  info = info || {\n    fpath: ''\n  };\n  var watcherPath = path.resolve(info.fpath);\n  this.watchers[watcherPath] = watcher; // Internal callback for handling fs.FSWatcher 'change' events\n\n  var internalOnChange = function (rawEvt, rawName) {\n    if (self.isClosed()) {\n      return;\n    } // normalise lack of name and convert to full path\n\n\n    var name = rawName;\n\n    if (is.nil(name)) {\n      name = '';\n    }\n\n    name = path.join(info.fpath, name);\n\n    if (info.options.recursive) {\n      hasNativeRecursive(function (has) {\n        if (!has) {\n          var fullPath = path.resolve(name); // remove watcher on removal\n\n          if (!is.exists(name)) {\n            self.close(fullPath);\n          } // watch new created directory\n          else if (is.directory(name) && !self.watchers[fullPath]) {\n              self.watchDirectory(name, info.options);\n            }\n        }\n      });\n    }\n\n    handlePublicEvents(rawEvt, name);\n  }; // Debounced based on the 'delay' option\n\n\n  var handlePublicEvents = debounce(info, function (evt, name) {\n    // watch single file\n    if (info.compareName) {\n      if (info.compareName(name)) {\n        self.emit('change', evt, name);\n      }\n    } // watch directory\n    else {\n        var filterGuard = guard(info.options.filter);\n        filterGuard(name, function () {\n          if (self.flag) self.flag = '';else self.emit('change', evt, name);\n        });\n      }\n  });\n  watcher.on('error', function (err) {\n    if (self.isClosed()) {\n      return;\n    }\n\n    if (is.windows() && err.code === 'EPERM') {\n      watcher.emit('change', EVENT_REMOVE, info.fpath && '');\n      self.flag = 'windows-error';\n      self.close(watcherPath);\n    } else {\n      self.emit('error', err);\n    }\n  });\n  watcher.on('change', internalOnChange);\n};\n\nWatcher.prototype.watchFile = function (file, options, fn) {\n  var parent = path.join(file, '../');\n  var opts = Object.assign({}, options, {\n    // no filter for single file\n    filter: null,\n    encoding: 'utf8'\n  }); // no need to watch recursively\n\n  delete opts.recursive;\n  var watcher = fs.watch(parent, opts);\n  this.add(watcher, {\n    type: 'file',\n    fpath: parent,\n    options: Object.assign({}, opts, {\n      encoding: options.encoding\n    }),\n    compareName: function (n) {\n      return is.samePath(n, file);\n    }\n  });\n\n  if (is.func(fn)) {\n    if (fn.length === 1) deprecationWarning();\n    this.on('change', fn);\n  }\n};\n\nWatcher.prototype.watchDirectory = function (dir, options, fn, counter = nullCounter) {\n  var self = this;\n  var done = counter();\n  hasNativeRecursive(function (has) {\n    // always specify recursive\n    options.recursive = !!options.recursive; // using utf8 internally\n\n    var opts = Object.assign({}, options, {\n      encoding: 'utf8'\n    });\n\n    if (!has) {\n      delete opts.recursive;\n    }\n\n    var watcher = fs.watch(dir, opts);\n    self.add(watcher, {\n      type: 'dir',\n      fpath: dir,\n      options: options\n    });\n\n    if (is.func(fn)) {\n      if (fn.length === 1) deprecationWarning();\n      self.on('change', fn);\n    }\n\n    if (options.recursive && !has) {\n      getSubDirectories(dir, function (d) {\n        self.watchDirectory(d, options, null, counter);\n      }, counter());\n    }\n\n    done();\n  });\n};\n\nfunction composeWatcher(watchers) {\n  var watcher = new Watcher();\n  var filterDups = createDupsFilter();\n  var counter = watchers.length;\n  watchers.forEach(function (w) {\n    w.on('change', filterDups(function (evt, name) {\n      watcher.emit('change', evt, name);\n    }));\n    w.on('error', function (err) {\n      watcher.emit('error', err);\n    });\n    w.on('ready', function () {\n      if (! --counter) {\n        emitReady(watcher);\n      }\n    });\n  });\n\n  watcher.close = function () {\n    watchers.forEach(function (w) {\n      w.close();\n    });\n    process.nextTick(emitClose, watcher);\n  };\n\n  return watcher.expose();\n}\n\nfunction watch(fpath, options, fn) {\n  var watcher = new Watcher();\n\n  if (is.buffer(fpath)) {\n    fpath = fpath.toString();\n  }\n\n  if (is.array(fpath)) {\n    if (fpath.length === 1) {\n      return watch(fpath[0], options, fn);\n    }\n\n    var filterDups = createDupsFilter();\n    return composeWatcher(unique(fpath).map(function (f) {\n      var w = watch(f, options);\n      if (fn) w.on('change', filterDups(fn));\n      return w;\n    }));\n  }\n\n  if (!is.exists(fpath)) {\n    watcher.emit('error', new Error(fpath + ' does not exist.'));\n  }\n\n  if (is.string(options)) {\n    options = {\n      encoding: options\n    };\n  }\n\n  if (is.func(options)) {\n    fn = options;\n    options = {};\n  }\n\n  if (arguments.length < 2) {\n    options = {};\n  }\n\n  if (options.encoding) {\n    assertEncoding(options.encoding);\n  } else {\n    options.encoding = 'utf8';\n  }\n\n  if (is.file(fpath)) {\n    watcher.watchFile(fpath, options, fn);\n    emitReady(watcher);\n  } else if (is.directory(fpath)) {\n    var counter = semaphore(function () {\n      emitReady(watcher);\n    });\n    watcher.watchDirectory(fpath, options, fn, counter);\n  }\n\n  return watcher.expose();\n}\n\nmodule.exports = watch;\nmodule.exports.default = watch;","map":{"version":3,"sources":["/Users/Zoorura/Documents/Projects/Zoorura/zoorura-webClient/node_modules/node-watch/lib/watch.js"],"names":["fs","require","path","util","events","hasNativeRecursive","is","EVENT_UPDATE","EVENT_REMOVE","hasDup","arr","some","v","i","self","indexOf","unique","filter","assertEncoding","encoding","Buffer","isEncoding","Error","guard","fn","arg","action","func","regExp","test","composeMessage","names","map","n","exists","getMessages","cache","filtered","reg","hasSpecialChar","c","dup","replace","m","windows","parents","parse","dir","samePath","debounce","info","timer","options","delay","number","handle","forEach","msg","from","toString","apply","rawEvt","name","push","setTimeout","createDupsFilter","memo","evt","Object","keys","getSubDirectories","done","directory","readdir","err","all","code","console","warn","f","sdir","join","semaphore","final","counter","start","stop","nullCounter","nullStop","deprecationWarning","deprecate","Watcher","EventEmitter","call","watchers","_isReady","_isClosed","inherits","prototype","expose","methods","reduce","arguments","isClosed","close","fullPath","watcher","fpath","emptyObject","process","nextTick","emitClose","emitReady","emit","add","watcherPath","resolve","internalOnChange","rawName","nil","recursive","has","watchDirectory","handlePublicEvents","compareName","filterGuard","flag","on","watchFile","file","parent","opts","assign","watch","type","length","d","composeWatcher","filterDups","w","buffer","array","string","module","exports","default"],"mappings":"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","sourcesContent":["var fs = require('fs');\nvar path = require('path');\nvar util = require('util');\nvar events = require('events');\n\nvar hasNativeRecursive = require('./has-native-recursive');\nvar is = require('./is');\n\nvar EVENT_UPDATE = 'update';\nvar EVENT_REMOVE = 'remove';\n\nfunction hasDup(arr) {\n  return arr.some(function(v, i, self) {\n    return self.indexOf(v) !== i;\n  });\n}\n\nfunction unique(arr) {\n  return arr.filter(function(v, i, self) {\n    return self.indexOf(v) === i;\n  });\n}\n\nfunction assertEncoding(encoding) {\n  if (encoding && encoding !== 'buffer' && !Buffer.isEncoding(encoding)) {\n    throw new Error('Unknown encoding: ' + encoding);\n  }\n}\n\nfunction guard(fn) {\n  return function(arg, action) {\n    if (is.func(fn)) {\n      if (fn(arg)) action();\n    }\n    else if (is.regExp(fn)) {\n      if (fn.test(arg)) action();\n    }\n    else {\n      action();\n    }\n  }\n}\n\nfunction composeMessage(names) {\n  return names.map(function(n) {\n    return is.exists(n)\n      ? [EVENT_UPDATE, n]\n      : [EVENT_REMOVE, n];\n  });\n}\n\nfunction getMessages(cache) {\n  var filtered = unique(cache);\n\n  // Saving file from an editor? If so, assuming the\n  // non-existed files in the cache are temporary files\n  // generated by an editor and thus be filtered.\n  var reg = /~$|^\\.#|^##$/g;\n  var hasSpecialChar = cache.some(function(c) {\n    return reg.test(c);\n  });\n\n  if (hasSpecialChar) {\n    var dup = hasDup(cache.map(function(c) {\n      return c.replace(reg, '');\n    }));\n    if (dup) {\n      filtered = filtered.filter(function(m) {\n        return is.exists(m);\n      });\n    }\n  }\n\n  // Prevent redundant event for its parent when creating file/directory.\n  // The operation is kinda expensive so only be triggered under Windows.\n  // https://github.com/yuanchuan/node-watch/issues/79\n  if (is.windows()) {\n    var parents = filtered.map(function(n) {\n      return path.parse(n).dir;\n    });\n    filtered = filtered.filter(function(n) {\n      // Skip on removal\n      if (!is.exists(n)) {\n        return true;\n      }\n      // Ignore the parent directory\n      return !parents.some(function(m) {\n        return is.samePath(n, m);\n      });\n    });\n  }\n\n  return composeMessage(filtered);\n}\n\nfunction debounce(info, fn) {\n  var timer, cache = [];\n  var encoding = info.options.encoding;\n  var delay = info.options.delay;\n  if (!is.number(delay)) {\n    delay = 200;\n  }\n  function handle() {\n    getMessages(cache).forEach(function(msg) {\n      msg[1] = Buffer.from(msg[1]);\n      if (encoding !== 'buffer') {\n        msg[1] = msg[1].toString(encoding);\n      }\n      fn.apply(null, msg);\n    });\n    timer = null;\n    cache = [];\n  }\n  return function(rawEvt, name) {\n    cache.push(name);\n    if (!timer) {\n      timer = setTimeout(handle, delay);\n    }\n  }\n}\n\nfunction createDupsFilter() {\n  var memo = {};\n  return function(fn) {\n    return function(evt, name) {\n      memo[evt + name] = [evt, name];\n      setTimeout(function() {\n        Object.keys(memo).forEach(function(n) {\n          fn.apply(null, memo[n]);\n        });\n        memo = {};\n      });\n    }\n  }\n}\n\nfunction getSubDirectories(dir, fn, done = function() {}) {\n  if (is.directory(dir)) {\n    fs.readdir(dir, function(err, all) {\n      if (err) {\n        // don't throw permission errors.\n        if (/^(EPERM|EACCES)$/.test(err.code)) {\n          console.warn('Warning: Cannot access %s.', dir);\n        } else {\n          throw err;\n        }\n      }\n      else {\n        all.forEach(function(f) {\n          var sdir = path.join(dir, f);\n          if (is.directory(sdir)) fn(sdir);\n        });\n        done();\n      }\n    });\n  } else {\n    done();\n  }\n}\n\nfunction semaphore(final) {\n  var counter = 0;\n  return function start() {\n    counter++;\n    return function stop() {\n      counter--;\n      if (counter === 0) final();\n    };\n  };\n}\n\nfunction nullCounter() {\n  return function nullStop() {};\n}\n\nvar deprecationWarning = util.deprecate(\n  function() {},\n  '(node-watch) First param in callback function\\\n  is replaced with event name since 0.5.0, use\\\n  `(evt, filename) => {}` if you want to get the filename'\n);\n\nfunction Watcher() {\n  events.EventEmitter.call(this);\n  this.watchers = {};\n  this._isReady = false;\n  this._isClosed = false;\n}\n\nutil.inherits(Watcher, events.EventEmitter);\n\nWatcher.prototype.expose = function() {\n  var self = this;\n  var methods = [\n    'on', 'emit', 'close', 'isClosed', 'listeners', 'once',\n    'setMaxListeners', 'getMaxListeners'\n  ];\n  return methods.reduce(function(expose, name) {\n    expose[name] = function() {\n      return self[name].apply(self, arguments);\n    }\n    return expose;\n  }, {});\n}\n\nWatcher.prototype.isClosed = function() {\n  return this._isClosed;\n}\n\nWatcher.prototype.close = function(fullPath) {\n  var self = this;\n  if (fullPath) {\n    var watcher = this.watchers[fullPath];\n    if (watcher && watcher.close) {\n      watcher.close();\n      delete self.watchers[fullPath];\n    }\n    getSubDirectories(fullPath, function(fpath) {\n      self.close(fpath);\n    });\n  }\n  else {\n    Object.keys(self.watchers).forEach(function(fpath) {\n      var watcher = self.watchers[fpath];\n      if (watcher && watcher.close) {\n        watcher.close();\n      }\n    });\n    this.watchers = {};\n  }\n  // Do not close the Watcher unless all child watchers are closed.\n  // https://github.com/yuanchuan/node-watch/issues/75\n  if (is.emptyObject(self.watchers)) {\n    this._isClosed = true;\n    process.nextTick(emitClose, this);\n  }\n};\n\nfunction emitReady(self) {\n  if (!self._isReady) {\n    self._isReady = true;\n    // do not call emit for 'ready' until after watch() has returned,\n    // so that consumer can call on().\n    process.nextTick(function () {\n      self.emit('ready');\n    });\n  }\n}\n\nfunction emitClose(self) {\n  self.emit('close');\n}\n\nWatcher.prototype.add = function(watcher, info) {\n  var self = this;\n  info = info || { fpath: '' };\n  var watcherPath = path.resolve(info.fpath);\n  this.watchers[watcherPath] = watcher;\n\n  // Internal callback for handling fs.FSWatcher 'change' events\n  var internalOnChange = function(rawEvt, rawName) {\n    if (self.isClosed()) {\n      return;\n    }\n\n    // normalise lack of name and convert to full path\n    var name = rawName;\n    if (is.nil(name)) {\n      name = '';\n    }\n    name = path.join(info.fpath, name);\n\n    if (info.options.recursive) {\n      hasNativeRecursive(function(has) {\n        if (!has) {\n          var fullPath = path.resolve(name);\n          // remove watcher on removal\n          if (!is.exists(name)) {\n            self.close(fullPath);\n          }\n          // watch new created directory\n          else if (is.directory(name) && !self.watchers[fullPath]) {\n            self.watchDirectory(name, info.options);\n          }\n        }\n      });\n    }\n\n    handlePublicEvents(rawEvt, name);\n  };\n\n  // Debounced based on the 'delay' option\n  var handlePublicEvents = debounce(info, function (evt, name) {\n    // watch single file\n    if (info.compareName) {\n      if (info.compareName(name)) {\n        self.emit('change', evt, name);\n      }\n    }\n    // watch directory\n    else {\n      var filterGuard = guard(info.options.filter);\n      filterGuard(name, function() {\n        if (self.flag) self.flag = '';\n        else self.emit('change', evt, name);\n      });\n    }\n  });\n\n  watcher.on('error', function(err) {\n    if (self.isClosed()) {\n      return;\n    }\n    if (is.windows() && err.code === 'EPERM') {\n      watcher.emit('change', EVENT_REMOVE, info.fpath && '');\n      self.flag = 'windows-error';\n      self.close(watcherPath);\n    } else {\n      self.emit('error', err);\n    }\n  });\n\n  watcher.on('change', internalOnChange);\n}\n\nWatcher.prototype.watchFile = function(file, options, fn) {\n  var parent = path.join(file, '../');\n  var opts = Object.assign({}, options, {\n    // no filter for single file\n    filter: null,\n    encoding: 'utf8'\n  });\n\n  // no need to watch recursively\n  delete opts.recursive;\n\n  var watcher = fs.watch(parent, opts);\n  this.add(watcher, {\n    type: 'file',\n    fpath: parent,\n    options: Object.assign({}, opts, {\n      encoding: options.encoding\n    }),\n    compareName: function(n) {\n      return is.samePath(n, file);\n    }\n  });\n\n  if (is.func(fn)) {\n    if (fn.length === 1) deprecationWarning();\n    this.on('change', fn);\n  }\n}\n\nWatcher.prototype.watchDirectory = function(dir, options, fn, counter = nullCounter) {\n  var self = this;\n  var done = counter();\n  hasNativeRecursive(function(has) {\n    // always specify recursive\n    options.recursive = !!options.recursive;\n    // using utf8 internally\n    var opts = Object.assign({}, options, {\n      encoding: 'utf8'\n    });\n    if (!has) {\n      delete opts.recursive;\n    }\n\n    var watcher = fs.watch(dir, opts);\n\n    self.add(watcher, {\n      type: 'dir',\n      fpath: dir,\n      options: options\n    });\n\n    if (is.func(fn)) {\n      if (fn.length === 1) deprecationWarning();\n      self.on('change', fn);\n    }\n\n    if (options.recursive && !has) {\n      getSubDirectories(dir, function(d) {\n        self.watchDirectory(d, options, null, counter);\n      }, counter());\n    }\n\n    done();\n  });\n}\n\nfunction composeWatcher(watchers) {\n  var watcher = new Watcher();\n  var filterDups = createDupsFilter();\n  var counter = watchers.length;\n  watchers.forEach(function(w) {\n    w.on('change', filterDups(function(evt, name) {\n      watcher.emit('change', evt, name);\n    }));\n    w.on('error', function(err) {\n      watcher.emit('error', err);\n    });\n    w.on('ready', function() {\n      if (!(--counter)) {\n        emitReady(watcher);\n      }\n    });\n  });\n\n  watcher.close = function() {\n    watchers.forEach(function(w) {\n      w.close();\n    });\n    process.nextTick(emitClose, watcher);\n  }\n  return watcher.expose();\n}\n\nfunction watch(fpath, options, fn) {\n  var watcher = new Watcher();\n\n  if (is.buffer(fpath)) {\n    fpath = fpath.toString();\n  }\n\n  if (is.array(fpath)) {\n    if (fpath.length === 1) {\n      return watch(fpath[0], options, fn);\n    }\n    var filterDups = createDupsFilter();\n    return composeWatcher(unique(fpath).map(function(f) {\n      var w = watch(f, options);\n      if (fn) w.on('change', filterDups(fn));\n      return w;\n    }));\n  }\n\n  if (!is.exists(fpath)) {\n    watcher.emit('error',\n      new Error(fpath + ' does not exist.')\n    );\n  }\n\n  if (is.string(options)) {\n    options = {\n      encoding: options\n    }\n  }\n\n  if (is.func(options)) {\n    fn = options;\n    options = {};\n  }\n\n  if (arguments.length < 2) {\n    options = {};\n  }\n\n  if (options.encoding) {\n    assertEncoding(options.encoding);\n  } else {\n    options.encoding = 'utf8';\n  }\n\n  if (is.file(fpath)) {\n    watcher.watchFile(fpath, options, fn);\n    emitReady(watcher);\n  }\n\n  else if (is.directory(fpath)) {\n    var counter = semaphore(function () {\n      emitReady(watcher);\n    });\n    watcher.watchDirectory(fpath, options, fn, counter);\n  }\n\n  return watcher.expose();\n}\n\nmodule.exports = watch;\nmodule.exports.default = watch;\n"]},"metadata":{},"sourceType":"script"}